FROM ##PREFIX##-notebook-base

RUN apt update && \
    apt install -y curl && \
    curl --silent --location https://deb.nodesource.com/setup_0.12 | sudo bash - && \
    apt install --yes nodejs npm && \
    npm install -g bower

RUN apt install -y tmux zip curlftpfs
RUN apt install -y liblapack-dev libblas-dev
RUN apt install -y gfortran libfreetype6* pkg-config
RUN apt install -y git gcc mpi-default-dev mpi-default-bin libfftw3-dev fftw3 cmake
RUN apt install -y davfs2
RUN apt install -y inotify-tools
RUN chmod u+s /usr/sbin/mount.davfs


# TODO add jupyter stuff
# Configure environment
ENV CONDA_VER "latest"
ENV CONDA_DIR /opt/conda
ENV PATH $CONDA_DIR/bin:$PATH
ENV SHELL /bin/bash
ENV LC_ALL en_US.UTF-8
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US.UTF-8

# Create conda dir
RUN mkdir -p $CONDA_DIR

# Maybe this one is not needed, since you can create conda envs into volumes
RUN chmod a+wrx $CONDA_DIR    

#Because of strange behaviour some trash hinders installation of the following into this directory
RUN rm -r /opt/*

# Install conda
RUN cd /tmp && \
    mkdir -p $CONDA_DIR && \
    wget --quiet https://repo.continuum.io/miniconda/Miniconda3-$CONDA_VER-Linux-x86_64.sh && \
    # echo "9ea57c0fdf481acf89d816184f969b04bc44dea27b258c4e86b1e3a25ff26aa0 *Miniconda3-3.19.0-Linux-x86_64.sh" | sha256sum -c - && \
    /bin/bash Miniconda3-$CONDA_VER-Linux-x86_64.sh -f -b -p $CONDA_DIR && \
    rm Miniconda3-$CONDA_VER-Linux-x86_64.sh 

RUN /opt/conda/bin/conda update -y conda

# WE NEED THIS TO BE ABLE TO RUN NOTEBOOK-SERVER WITHOUT ANY EXTERNAL VOLUME/MODUL etc...
RUN $CONDA_DIR/bin/conda install --quiet --yes  jupyter_core jupyter_client jupyter_console 
RUN $CONDA_DIR/bin/conda install --quiet --yes  notebook widgetsnbextension
RUN  $CONDA_DIR/bin/conda install --quiet --yes -c conda-forge jupyter_dashboards && \
     jupyter dashboards quick-setup --sys-prefix
RUN  $CONDA_DIR/bin/conda install --quiet --yes -c conda-forge jupyter_cms && \
     jupyter cms quick-setup --sys-prefix


# TO SWITCH BETWEEN CONDA ENVS
RUN pip install environment_kernels

RUN apt install -y autoconf libncurses5-dev libncursesw5-dev zlib1g-dev libbz2-dev liblzma-dev apt-rdepends 
 
RUN apt install -y libblacs-mpi-dev libscalapack-mpi-dev
 

RUN  $CONDA_DIR/bin/conda install --quiet --yes -c conda-forge ipywidgets=7.0 traittypes
RUN  $CONDA_DIR/bin/conda install --quiet --yes -c conda-forge bqplot
RUN jupyter nbextension enable --py --sys-prefix widgetsnbextension

RUN $CONDA_DIR/bin/conda install -v --yes  -c conda-forge parso=0.1.0


RUN $CONDA_DIR/bin/conda install --quiet --yes -c damianavila82 rise pivottablejs
RUN $CONDA_DIR/bin/conda install --quiet --yes  -c conda-forge ipyleaflet folium
RUN $CONDA_DIR/bin/conda install --quiet --yes seaborn pandas
RUN $CONDA_DIR/bin/conda install --quiet --yes  -c conda-forge altair branca vega vincent 

RUN apt update
RUN apt install -y libfontconfig1 libxrender1 libxrender-dev
RUN apt install -y g++-5 libicu-dev libxml2-dev
##RUN apt install -y octave # when setting up ca-certificate-java it dead locks

RUN $CONDA_DIR/bin/conda update -y notebook
RUN $CONDA_DIR/bin/conda update -y jupyter_client

RUN $CONDA_DIR/bin/conda install --quiet --yes  -c conda-forge jupyterlab

RUN $CONDA_DIR/bin/conda install --quiet --yes nb_conda nb_conda_kernels

RUN $CONDA_DIR/bin/conda install --quiet --yes  -c conda-forge jupyter_nbextensions_configurator
RUN $CONDA_DIR/bin/conda install --quiet --yes  -c conda-forge jupyter_contrib_nbextensions

RUN $CONDA_DIR/bin/conda install --quiet --yes  -c conda-forge jupyter_nbextensions_configurator
RUN $CONDA_DIR/bin/conda install -v --quiet --yes  -c conda-forge jupyter_contrib_nbextensions

RUN $CONDA_DIR/bin/conda install -v --quiet --yes nodejs
RUN $CONDA_DIR/bin/conda install -v --quiet --yes networkx

RUN jupyter labextension install @jupyter-widgets/jupyterlab-manager #@0.33
#RUN apt install -y texlive-xetex texlive-lang-european texlive-science
#RUN pip install jupyterlab_latex && jupyter serverextension enable --sys-prefix jupyterlab_latex && jupyter labextension install @jupyterlab/latex
RUN jupyter labextension install @jupyterlab/github #@0.5

RUN jupyter labextension install jupyterlab_vim

#RUN jupyter labextension install jupyterlab_bokeh
# pip install jupyterlab-discovery
#jupyter labextension install @mflevine/jupyterlab_html
#jupyter labextension install knowledgelab


ADD jupyter-notebook-kooplex /opt/conda/bin/jupyter-notebook-kooplex 
RUN chmod a+x /opt/conda/bin/jupyter-notebook-kooplex

# Add local files as late as possible to avoid cache busting
ADD start-notebook.sh /usr/local/bin/start-notebook.sh
ADD kooplex-logo.png /opt/conda/lib/python3.6/site-packages/notebook/static/base/images/kooplex-logo.png
ADD kooplex-logo.png /opt/conda/lib/python3.5/site-packages/notebook/static/base/images/kooplex-logo.png

RUN sed -i -e "s/^\(UMASK\).*/\1 0002/" /etc/login.defs

########## add the rest
RUN mkdir -p /init

ADD 01-startnslcd.sh /init/01-startnslcd.sh
ADD 02-mountuserhome.sh /init/02-mountuserhome.sh
ADD 03-startinotify.sh /init/03-startinotify.sh
ADD 99-startnotebookserver.sh /init/99-startnotebookserver.sh
ADD jupyter_notebook_config.py /etc/jupyter_notebook_config.py
ADD nslcd.conf /etc/nslcd.conf
ADD ldap.conf /etc/ldap/ldap.conf
ADD nsswitch.conf /etc/nsswitch.conf

ADD manage_mount.sh /usr/local/sbin/manage_mount.sh
RUN chmod +x /usr/local/sbin/manage_mount.sh 

